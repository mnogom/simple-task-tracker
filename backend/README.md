### 1. Dependencies
```
poetry add 'fastapi[all]' 'uvicorn[standart]' `pydantic[email]` sqlalchemy alembic python-dotenv
poetry add flake8 pytest --dev  
```

### 2. Setup SQLAlchemy and Alembic

1. Create env [todo]
    `./.env`
    ```
    SQL_DRIVER=sqlite
    ```

---------------------------------------------

2. Create config. Based on <sup>[4]</sup> [todo]
    `./app/app/core/config.py`
    ```python
    import os
    
    from pydantic import BaseSettings
    import dotenv
    
    dotenv.load_dotenv()
    
    
    class Settings(BaseSettings):
        db_driver: str = os.getenv('SQL_DRIVER')
        db_url: str = 'sqlite:///./sql_app.db' if db_driver == 'sqlite3' else ''
    
    
    settings = Settings()
    ```

---------------------------------------------

3. Create SQLAlchemy models
   * Create `Session`
      ```python
      from sqlalchemy import create_engine
      from sqlalchemy.orm import sessionmaker
      
      from app.core.config import settings
      
      SQLALCHEMY_DATABASE_URL = settings.db_url
      
      engine = create_engine(
          SQLALCHEMY_DATABASE_URL,
          pool_pre_ping=True,
          future=True,
          echo=True
      )
      SessionLocal = sessionmaker(
          autocommit=False,
          autoflush=False,
          bind=engine
      )
      ```
   * Create `Base` class at `/app/db/base_class.py
       ```python
       # https://docs.sqlalchemy.org/en/14/orm/mapping_api.html#sqlalchemy.orm.as_declarative
       
       from typing import Any
       
       from sqlalchemy.ext.declarative import as_declarative, declared_attr
       
       
       @as_declarative()
       class Base:
           id: Any
           __name__: str
       
           @declared_attr
           def __tablename__(cls) -> str:
               return cls.__name__.lower()
       ```
   * Now models:

      * `/app/models/user.py`
      ```python
      from sqlalchemy import Column, Boolean, Integer, String
      from sqlalchemy.orm import relationship
      
      from app.db.base_class import Base
      
      
      class User(Base):
          id = Column(Integer, primary_key=True, index=True)
          full_name = Column(String, index=True)
          email = Column(String, unique=True, index=True)
          hashed_password = Column(String)
          is_active = Column(Boolean, default=True)
          is_superuser = Column(Boolean, default=False)
      
          tasks = relationship('Task', back_populates='owner')
      ```

      * `/app/models/task.py`
      ```python
      import enum
      
      from sqlalchemy import Column, Integer, String, ForeignKey, Enum, Date
      from sqlalchemy.orm import relationship
      from sqlalchemy.sql import func
      
      from app.db.base_class import Base
      
      
      class Statuses(enum.Enum):
          not_started = 'Not started'
          in_progress = 'In progress'
          finished = 'Finished'
          canceled = 'Canceled'
      
      
      class Task(Base):
          id = Column(Integer, primary_key=True, index=True)
          name = Column(String, index=True)
          description = Column(String)
          owner_id = Column(Integer, ForeignKey('user.id'))
          status = Column(Enum(Statuses), default=Statuses.not_started)
          created_at = Column(Date, default=func.now())
          deadline = Column(Date)
      
          owner = relationship('User', back_populates='tasks')
      ```

      * Add all models to `/app/models/__init__.py`
      ```python
      from .user import User
      from .task import Task
      ```

   * Create `/app/db/base.py` for alembic autogenerated migrations <sup>[4], [5]</sup>
      ```python
      from .base_class import Base
      from app.models import *
      ```

---------------------------------------------

4. Alembic setup <sup>[1], [4]</sup>
    * Init
       ```
       alembic init --template generic alembic
       ```
       there will be created `/alembic/` and `/alembic.ini`

    * Edit `/alembic/env.py` <sup>[4], [5]</sup>

       Add import `Base` class and `settings` instance
       ```python
       from app.core.settings import settings
       ```

        Change this:
        ```python
        target_metadata = None
        ```
        to this:
        ```python
        from app.db.base_class import Base
            
        target_metadata = Base.metadata
        ```
   
       Create function `get_url()`
       ```python
       def get_url():
           return settings.db_url
       ```
   
       In function `run_migrations_offline()` change this:
       ```python
       url = settings.db_url
       ```
       to this:
       ```python
       url = get_url()
       ```
   
       In function `run_migrations_online()` change this:
       ```python
       connectable = engine_from_config(
           config.get_section(config.config_ini_section),
           prefix="sqlalchemy.",
           poolclass=pool.NullPool,
       )
       ```
       to this:
       ```python
       configuration = config.get_section(config.config_ini_section)
       configuration["sqlalchemy.url"] = get_url()
       connectable = engine_from_config(
           configuration,
           prefix="sqlalchemy.",
           poolclass=pool.NullPool,
       )
       ```

    * Edit `/alembic.ini`. **REMOVE** this string
       ```
       sqlalchemy.url = driver://user:pass@localhost/dbname
       ```
    
    * Now create migrations and migrate
       ```
       poetry run alembic revision --autogenerate -m "Initial migration"
       poetry run alembic upgrade head
       ```
       After this you can find /sql_app.db


---------------------------------------------

### 3. Pydantic schemas


### 4. CRUD

### SRC:
1. https://alembic.sqlalchemy.org/en/latest/tutorial.html
2. https://fastapi.tiangolo.com/tutorial/sql-databases/
3. https://fastapi.tiangolo.com/tutorial/first-steps/
4. https://github.com/tiangolo/full-stack-fastapi-postgresql
5. https://alembic.sqlalchemy.org/en/latest/autogenerate.html